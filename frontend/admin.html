<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin NOKOSKU</title>
  <link href="/assets/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-5">
    <h1>Admin Dashboard</h1>
    <div id="stats"></div>
    <div id="users"></div>
    <div id="markup"></div>
    <div id="audit"></div>
  </div>
  <script>
    const token = localStorage.getItem('token');
    if (!token) location.href = '/login.html';

    async function loadStats() {
      const res = await fetch('/api/v1/admin/stats', { headers: { Authorization: 'Bearer ' + token } });
      const data = await res.json();
      document.getElementById('stats').innerHTML = `
        <h2>Stats</h2>
        <p>Total Users: ${data.stats.totalUsers}</p>
        <p>Total Deposits: Rp${data.stats.totalDeposits}</p>
        <p>Total Orders: ${data.stats.totalOrders}</p>
        <p>Total Profit: Rp${data.stats.totalProfit}</p>
      `;
    }

    async function loadUsers() {
      const res = await fetch('/api/v1/admin/users', { headers: { Authorization: 'Bearer ' + token } });
      const data = await res.json();
      let html = '<h2>Users</h2><table class="table"><thead><tr><th>Email</th><th>Balance</th><th>Action</th></tr></thead><tbody>';
      data.users.forEach(u => {
        html += `<tr><td>${u.email}</td><td>Rp${u.balance}</td><td><button onclick="banUser(${u.id})">Ban</button></td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('users').innerHTML = html;
    }

    async function banUser(id) {
      await fetch(`/api/v1/admin/users/${id}`, {
        method: 'PUT',
        headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_banned: true })
      });
      loadUsers();
    }

    async function loadMarkup() {
      const res = await fetch('/api/v1/admin/markup', { headers: { Authorization: 'Bearer ' + token } });
      const data = await res.json();
      let html = '<h2>Markup Rules</h2><form id="markupForm"><div class="mb-3"><label>Service</label><input class="form-control" id="markupService"></div><div class="mb-3"><label>Country</label><input class="form-control" id="markupCountry"></div><div class="mb-3"><label>Markup</label><input class="form-control" type="number" id="markupValue"></div><button type="submit" class="btn btn-primary">Set Markup</button></form><h3>Current Rules</h3><ul>';
      data.rules.forEach(r => {
        html += `<li>${r.service} - ${r.country} - Rp${r.markup}</li>`;
      });
      html += '</ul>';
      document.getElementById('markup').innerHTML = html;

      document.getElementById('markupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const service = document.getElementById('markupService').value;
        const country = document.getElementById('markupCountry').value;
        const markup = document.getElementById('markupValue').value;
        await fetch('/api/v1/admin/markup', {
          method: 'POST',
          headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ service, country, markup })
        });
        loadMarkup();
      });
    }

    async function loadAudit() {
      const res = await fetch('/api/v1/admin/audit', { headers: { Authorization: 'Bearer ' + token } });
      const data = await res.json();
      let html = '<h2>Audit Logs</h2><ul>';
      data.logs.forEach(l => {
        html += `<li>${l.event}: ${l.detail} - ${new Date(l.created_at).toLocaleString()}</li>`;
      });
      html += '</ul>';
      document.getElementById('audit').innerHTML = html;
    }

    loadStats();
    loadUsers();
    loadMarkup();
    loadAudit();
  </script>
</body>
</html>