<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOKOSKU - Panel SMM Modern</title>
  <link href="/assets/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
   <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
   <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
   <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
   <script src="https://unpkg.com/@lottiefiles/dotlottie-web@latest/dist/index.js"></script>
   <script type="module" src="/js/lottie.js"></script>
  <style>
    body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .sidebar { width: 250px; height: 100vh; position: fixed; top: 0; left: 0; background: #343a40; color: white; padding: 20px; display: none; }
    .sidebar.show { display: block; }
    .topbar { background: white; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .content { margin-left: 0; padding: 20px; transition: margin-left 0.3s; }
    .content.shift { margin-left: 250px; }
    .card { border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .saldo-card { background: linear-gradient(45deg, #667eea, #764ba2); color: white; }
    .badge-pending { background: #ffc107; }
    .badge-processing { background: #007bff; }
    .badge-success { background: #28a745; }
    .badge-failed { background: #dc3545; }
    .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #dee2e6; display: flex; justify-content: space-around; padding: 10px 0; }
    .bottom-nav a { text-decoration: none; color: #6c757d; }
    .bottom-nav a.active { color: #007bff; }
    @media (min-width: 768px) { .sidebar { display: block; } .content { margin-left: 250px; } .bottom-nav { display: none; } }
    .swal-wide { width: 80vw !important; }
    #lottie-container { margin: 0 auto; }
  </style>
</head>
<body>
  <!-- Sidebar (Desktop) -->
  <div class="sidebar" id="sidebar">
    <h4>NOKOSKU</h4>
    <ul class="list-unstyled">
      <li><a href="#" class="text-white" onclick="showDashboard()">Dashboard</a></li>
      <li><a href="#" class="text-white" onclick="showDeposit()">Deposit</a></li>
      <li><a href="#" class="text-white" onclick="showBuyNumber()">Beli Nomor</a></li>
      <li><a href="#" class="text-white" onclick="showOrders()">Riwayat Order</a></li>
      <li><a href="#" class="text-white" onclick="showProfile()">Profil</a></li>
    </ul>
  </div>

  <!-- Topbar -->
  <div class="topbar d-flex justify-content-between align-items-center">
    <button class="btn btn-outline-secondary d-md-none" onclick="toggleSidebar()">â˜°</button>
    <span id="user-info">Selamat datang di NOKOSKU</span>
    <div id="top-actions">
      <button class="btn btn-success" onclick="showDeposit()">Deposit</button>
      <span id="balance-display">Saldo: Rp0</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content" id="main-content">
    <div class="container-fluid">
      <!-- Landing/Dashboard -->
      <div id="landing" class="text-center">
        <h1>Selamat Datang di NOKOSKU</h1>
        <p>Panel SMM modern untuk beli nomor virtual OTP.</p>
        <div id="lottie-container"></div>
        <button class="btn btn-primary mt-3" onclick="showLogin()">Login</button>
        <button class="btn btn-secondary mt-3" onclick="showRegister()">Register</button>
      </div>

      <!-- Dashboard Content -->
      <div id="dashboard-content" style="display:none;">
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card saldo-card text-white">
              <div class="card-body">
                <h5>Saldo Anda</h5>
                <h3 id="saldo-amount">Rp0</h3>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <h4>Quick Actions</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-success" onclick="showDeposit()">Deposit QRIS</button>
              <button class="btn btn-primary" onclick="showBuyNumber()">Beli Nomor</button>
              <button class="btn btn-info" onclick="showOrders()">Lihat Orders</button>
            </div>
          </div>
        </div>

        <!-- Recent Orders Table -->
        <div class="card">
          <div class="card-header">
            <h5>Order Terbaru</h5>
            <input type="text" class="form-control mt-2" placeholder="Cari order..." id="search-order">
          </div>
          <div class="card-body">
            <div class="d-flex gap-2 mb-3">
              <span class="badge badge-pending">Pending</span>
              <span class="badge badge-processing">Processing</span>
              <span class="badge badge-success">Success</span>
              <span class="badge badge-failed">Failed</span>
            </div>
            <table class="table table-striped" id="orders-table">
              <thead>
                <tr>
                  <th>Nomor</th>
                  <th>Aplikasi</th>
                  <th>Status</th>
                  <th>Tanggal</th>
                </tr>
              </thead>
              <tbody id="orders-tbody">
                <!-- Orders will be loaded here -->
              </tbody>
            </table>
            <nav aria-label="Pagination">
              <ul class="pagination" id="pagination">
                <!-- Pagination will be here -->
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav (Mobile) -->
  <div class="bottom-nav d-md-none">
    <a href="#" onclick="showDashboard()" class="active"><i class="bi bi-house"></i><br>Dashboard</a>
    <a href="#" onclick="showDeposit()"><i class="bi bi-cash"></i><br>Deposit</a>
    <a href="#" onclick="showBuyNumber()"><i class="bi bi-phone"></i><br>Beli</a>
    <a href="#" onclick="showOrders()"><i class="bi bi-list"></i><br>Orders</a>
    <a href="#" onclick="showProfile()"><i class="bi bi-person"></i><br>Profil</a>
  </div>

  <!-- Modals -->
  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="loginEmail" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Register</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="registerForm">
            <div class="mb-3">
              <label class="form-label">Nama</label>
              <input type="text" class="form-control" id="registerName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="registerEmail" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" id="registerPassword" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Register</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" style="position:fixed;top:10px;right:10px;z-index:9999"></div>

  <script src="/js/event-handler.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { preloadLottie, mountLottie, destroyLottie, lottieUrls } from '/js/lottie.js';

    // Preload all Lottie on app start
    (async () => {
      await preloadLottie(Object.values(lottieUrls));
      console.log('All Lottie preloaded');
      const el = document.getElementById('lottie-container');
      if (el) mountLottie(el, lottieUrls.intro, { loop: true, autoplay: true, size: 200 });
    })();

    window.mountLottie = mountLottie;
    window.destroyLottie = destroyLottie;
    window.lottieUrls = lottieUrls;
    });

    // Show modals
    function showLogin() {
      new bootstrap.Modal(document.getElementById('loginModal')).show();
    }
    function showRegister() {
      new bootstrap.Modal(document.getElementById('registerModal')).show();
    }

    // Form handlers
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      try {
        const res = await axios.post('/api/v1/auth/login', { email, password });
        if (res.data.success) {
          localStorage.setItem('token', res.data.token);
          localStorage.setItem('user', JSON.stringify(res.data));
          showDashboard();
          bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        }
      } catch (err) {
        Swal.fire('Error', err.response?.data?.error || 'Login gagal', 'error');
      }
    });

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('registerName').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      try {
        const res = await axios.post('/api/v1/auth/register', { name, email, password });
        if (res.data.success) {
          Swal.fire('Success', 'Registrasi berhasil, silakan login', 'success');
          bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
        }
      } catch (err) {
        Swal.fire('Error', err.response?.data?.error || 'Registrasi gagal', 'error');
      }
    });

    // Dashboard after login
    function showDashboard() {
      document.getElementById('landing').style.display = 'none';
      document.getElementById('dashboard-content').style.display = 'block';
      loadBalance();
      loadRecentOrders();
    }

    async function loadBalance() {
      const token = localStorage.getItem('token');
      try {
        const res = await axios.get('/api/v1/user/balance', { headers: { Authorization: `Bearer ${token}` } });
        document.getElementById('saldo-amount').textContent = `Rp${res.data.balance}`;
        document.getElementById('balance-display').textContent = `Saldo: Rp${res.data.balance}`;
      } catch (err) {
        console.error('Balance error:', err);
      }
    }

    async function loadRecentOrders() {
      const token = localStorage.getItem('token');
      try {
        const res = await axios.get('/api/v1/orders/history', { headers: { Authorization: `Bearer ${token}` } });
        const tbody = document.getElementById('orders-tbody');
        tbody.innerHTML = res.data.orders.slice(0, 10).map(o => `
          <tr>
            <td>${o.number}</td>
            <td>${o.service}</td>
            <td><span class="badge badge-${o.status}">${o.status}</span></td>
            <td>${new Date(o.created_at).toLocaleDateString()}</td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Orders error:', err);
      }
    }
    }

    function showDeposit() {
      Swal.fire({
        title: 'Deposit QRIS',
        html: `
          <input type="number" id="depositAmount" class="form-control" placeholder="Nominal (min 5000)" min="5000" required>
          <div id="qrContainer" class="mt-3" style="display:none;">
            <canvas id="qrcode"></canvas>
            <p>Scan QR untuk bayar. Status akan update otomatis.</p>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Buat Deposit',
        preConfirm: async () => {
          const amount = document.getElementById('depositAmount').value;
          const token = localStorage.getItem('token');
          const res = await axios.post('/api/v1/deposit/create', { nominal: amount, metode: 'atlantic' }, { headers: { Authorization: `Bearer ${token}` } });
          if (res.data.success) {
            QRCode.toCanvas(document.getElementById('qrcode'), res.data.deposit.qr_string, { width: 200 });
            document.getElementById('qrContainer').style.display = 'block';
            if (window.mountLottie && window.lottieUrls) {
              const el = document.createElement('div');
              document.body.appendChild(el);
              window.mountLottie(el, window.lottieUrls.loading, { loop: true, autoplay: true, size: 100 });
            }
            return res;
          } else {
            throw new Error(res.data.error);
          }
        }
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire('Success', 'Deposit dibuat. Scan QR untuk bayar.', 'success');
        }
      }).catch((err) => {
        Swal.fire('Error', err.message || 'Deposit gagal', 'error');
      });
    }

    function showBuyNumber() {
      Swal.fire({
        title: 'Beli Nomor Virtual',
        html: `
          <select class="form-select mb-3" id="serviceSelect">
            <option value="whatsapp">WhatsApp</option>
            <option value="telegram">Telegram</option>
            <option value="instagram">Instagram</option>
          </select>
          <button class="btn btn-primary" onclick="loadCountries()">Lanjut</button>
          <div id="countriesContainer" class="mt-3"></div>
          <div id="operatorsContainer"></div>
          <div id="orderContainer"></div>
        `,
        showConfirmButton: false,
        customClass: { popup: 'swal-wide' }
      });
    }

    async function loadCountries() {
      const service = document.getElementById('serviceSelect').value;
      const token = localStorage.getItem('token');
      try {
        const res = await axios.get(`/api/v1/orders/countries/${service}`, { headers: { Authorization: `Bearer ${token}` } });
        const html = res.data.countries.map(c => `<button class="btn btn-outline-primary m-1" onclick="selectCountry('${c.code}', '${c.name}')">${c.name}</button>`).join('');
        document.getElementById('countriesContainer').innerHTML = `<h5>Pilih Negara</h5>${html}`;
      } catch (err) {
        Swal.fire('Error', 'Gagal load negara', 'error');
      }
    }

    function selectCountry(code, name) {
      document.getElementById('operatorsContainer').innerHTML = `<h5>Pilih Operator untuk ${name}</h5><button class="btn btn-success" onclick="createOrder('${code}')">Beli Nomor</button>`;
    }

    async function createOrder(countryCode) {
      const service = document.getElementById('serviceSelect').value;
      const token = localStorage.getItem('token');
      try {
        const res = await axios.post('/api/v1/orders/create', { service_code: service, country_name: countryCode }, { headers: { Authorization: `Bearer ${token}` } });
        if (res.data.success) {
          document.getElementById('orderContainer').innerHTML = `
            <div class="alert alert-success">
              <h5>Nomor: ${res.data.order.number}</h5>
              <p>Status: Pending. Tunggu OTP masuk. <span class="countdown" id="countdown">15:00</span></p>
              <button class="btn btn-info" onclick="askOtpNotif()">Mau dikabarin pas OTP masuk?</button>
            </div>
          `;
          startCountdown();
          Swal.fire('Success', 'Order berhasil. Tunggu OTP.', 'success');
          if (window.mountLottie && window.lottieUrls) {
            const el = document.createElement('div');
            document.body.appendChild(el);
            window.mountLottie(el, window.lottieUrls.waiting, { loop: true, autoplay: true, size: 100 });
          }
        }
      } catch (err) {
        Swal.fire('Error', err.response?.data?.error || 'Order gagal', 'error');
        if (window.mountLottie && window.lottieUrls) {
          const el = document.createElement('div');
          document.body.appendChild(el);
          window.mountLottie(el, window.lottieUrls.error, { loop: false, autoplay: true, size: 100 });
        }
      }
    }

    function startCountdown() {
      let time = 15 * 60;
      const timer = setInterval(() => {
        const min = Math.floor(time / 60);
        const sec = time % 60;
        document.getElementById('countdown').textContent = `${min}:${sec.toString().padStart(2, '0')}`;
        if (time <= 0) {
          clearInterval(timer);
          document.getElementById('countdown').textContent = 'Expired';
        }
        time--;
      }, 1000);
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('show');
      document.getElementById('main-content').classList.toggle('shift');
    }

    function showOrders() {
      // Show orders page
    }

    function showProfile() {
      // Show profile page
    }

    // Check if logged in
    if (localStorage.getItem('token')) {
      showDashboard();
    }
  </script>
  <script>
    // Fallback if Lottie fails
    window.addEventListener('error', function(e) {
      if (e.target.tagName === 'SCRIPT' && e.target.src.includes('lottie')) {
        console.warn('Lottie script failed to load');
        // Fallback to simple loading text
        document.getElementById('lottie-container').innerHTML = '<p>Loading...</p>';
      }
    });
  </script>
</body>
</html>
